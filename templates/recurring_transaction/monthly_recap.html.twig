{% extends 'base.html.twig' %}

{% block title %}R√©cap mensuel - Transactions r√©currentes - OnlyFlooze{% endblock %}

{% block body %}
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 text-primary">üìÖ R√©cap mensuel - Transactions r√©currentes</h1>
            <div>
                <a href="{{ path('app_recurring_transaction_index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </div>

        <!-- S√©lecteur de mois -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">S√©lection du mois budg√©taire</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <!-- Bouton mois pr√©c√©dent -->
                            {% set previousMonth = selected_month|date_modify('-1 month')|date('Y-m') %}
                            <a href="{{ path('app_recurring_transaction_monthly_recap', {'month': previousMonth}) }}"
                               class="btn btn-outline-secondary me-3" title="Mois pr√©c√©dent">
                                <i class="fas fa-chevron-left"></i>
                            </a>

                            <!-- S√©lecteur de mois -->
                            <div class="flex-grow-1">
                                <form method="GET" class="d-flex align-items-center">
                                    <select class="form-select" id="month" name="month" onchange="this.form.submit()">
                                        {% for month in monthly_data.available_months %}
                                            <option value="{{ month }}"
                                                    {% if month == selected_month %}selected{% endif %}>
                                                {% set monthNames = {
                                                    '01': 'janvier', '02': 'f√©vrier', '03': 'mars', '04': 'avril',
                                                    '05': 'mai', '06': 'juin', '07': 'juillet', '08': 'ao√ªt',
                                                    '09': 'septembre', '10': 'octobre', '11': 'novembre', '12': 'd√©cembre'
                                                } %}
                                                {{ monthNames[month|date('m')] }} {{ month|date('Y') }}
                                            </option>
                                        {% endfor %}
                                        <!-- Ajouter le mois courant s'il n'existe pas -->
                                        {% if selected_month not in monthly_data.available_months %}
                                            <option value="{{ selected_month }}" selected>
                                                {% set monthNames = {
                                                    '01': 'janvier', '02': 'f√©vrier', '03': 'mars', '04': 'avril',
                                                    '05': 'mai', '06': 'juin', '07': 'juillet', '08': 'ao√ªt',
                                                    '09': 'septembre', '10': 'octobre', '11': 'novembre', '12': 'd√©cembre'
                                                } %}
                                                {{ monthNames[selected_month|date('m')] }} {{ selected_month|date('Y') }}
                                                (nouveau)
                                            </option>
                                        {% endif %}
                                    </select>
                                </form>
                            </div>

                            <!-- Bouton mois suivant -->
                            {% set nextMonth = selected_month|date_modify('+1 month')|date('Y-m') %}
                            <a href="{{ path('app_recurring_transaction_monthly_recap', {'month': nextMonth}) }}"
                               class="btn btn-outline-secondary ms-3" title="Mois suivant">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted mb-0">
                            <i class="fas fa-info-circle"></i>
                            Naviguez entre les mois pour voir le statut de vos transactions r√©currentes
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©sum√© des totaux -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h5 class="card-title text-danger">üí∏ D√©j√† sorti</h5>
                        <h3 class="text-danger fw-bold">
                            {{ monthly_data.totals.already_out|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                        </h3>
                        <small class="text-muted">Montants n√©gatifs r√©alis√©s</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h5 class="card-title text-success">üí∞ D√©j√† rentr√©</h5>
                        <h3 class="text-success fw-bold">
                            {{ monthly_data.totals.already_in|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                        </h3>
                        <small class="text-muted">Montants positifs r√©alis√©s</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h5 class="card-title text-warning">üì§ Pr√©vu √† sortir</h5>
                        <h3 class="text-warning fw-bold">
                            {{ monthly_data.totals.expected_out|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                        </h3>
                        <small class="text-muted">Montants n√©gatifs attendus</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h5 class="card-title text-info">üì• Pr√©vu √† rentrer</h5>
                        <h3 class="text-info fw-bold">
                            {{ monthly_data.totals.expected_in|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                        </h3>
                        <small class="text-muted">Montants positifs attendus</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barre de progression -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">Progression du mois</span>
                    <span class="text-muted">
                        {% set percentage = monthly_data.totals.expected != 0 ? (monthly_data.totals.paid / monthly_data.totals.expected * 100) : 0 %}
                        {{ percentage|number_format(1) }}%
                    </span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: {{ percentage|number_format(2) }}%"
                         aria-valuenow="{{ percentage|number_format(2) }}"
                         aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste d√©taill√©e des transactions r√©currentes -->
        {% if monthly_data.recurring_transactions|length > 0 %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">D√©tail par transaction r√©currente</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                            <tr>
                                <th width="50">Statut</th>
                                <th>Transaction r√©currente</th>
                                <th class="text-end">Montant attendu</th>
                                <th class="text-end">Montant pay√©</th>
                                <th class="text-center">Nb transactions</th>
                                <th>Derni√®re transaction</th>
                                <th class="text-center">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for item in monthly_data.recurring_transactions %}
                                <tr class="{% if item.is_paid %}table-success{% else %}table-warning{% endif %}">
                                    <td class="text-center">
                                        {% if item.is_paid %}
                                            <i class="fas fa-check-circle text-success" title="Pay√©"></i>
                                        {% else %}
                                            <i class="fas fa-clock text-warning" title="En attente"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <strong>{{ item.recurring_transaction.name }}</strong>
                                                <br><small class="text-muted">
                                                    {{ item.unit_amount|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                                                    √ó {{ item.expected_frequency }}
                                                    {% if item.expected_frequency > 1 %}occurrences{% else %}occurrence{% endif %}
                                                </small>
                                                {% if not item.is_paid and item.remaining_amount > 0 %}
                                                    <br><small class="text-warning">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    {{ item.remaining_amount|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                                                    restant
                                                </small>
                                                {% elseif item.is_paid and item.remaining_amount > 0 %}
                                                    <br><small class="text-info">
                                                    <i class="fas fa-info-circle"></i>
                                                    {{ item.remaining_amount|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                                                    restant
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <span
                                            class="{% if item.expected_amount >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                            {{ item.expected_amount|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        {% if item.is_paid %}
                                            <span
                                                class="{% if item.paid_amount >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                                {{ item.paid_amount|number_format(2, ',', ' ') }}&nbsp;‚Ç¨
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if item.transactions_count > 0 %}
                                            <span class="badge bg-info">{{ item.transactions_count }}</span>
                                        {% else %}
                                            <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.latest_transaction %}
                                            <div>
                                                <strong>{{ item.latest_transaction.label }}</strong><br>
                                                <small class="text-muted">
                                                    {{ item.latest_transaction.transactionDate|date('d/m/Y') }}
                                                </small>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">Aucune</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ path('app_recurring_transaction_show', {'id': item.recurring_transaction.id}) }}"
                                               class="btn btn-outline-info" title="Voir les d√©tails">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if not item.is_paid %}
                                                <a href="{{ path('app_transaction_new') }}?recurring={{ item.recurring_transaction.id }}&month={{ selected_month }}"
                                                   class="btn btn-outline-success" title="Cr√©er transaction">
                                                    <i class="fas fa-plus"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-calendar-times fs-1 text-muted"></i>
                    </div>
                    <h4 class="text-muted">Aucune transaction r√©currente</h4>
                    <p class="text-muted">Vous n'avez pas encore de transactions r√©currentes configur√©es.</p>
                    <a href="{{ path('app_recurring_transaction_new') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Cr√©er une transaction r√©currente
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
